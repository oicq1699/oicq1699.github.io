# Quartz 库中cron表达式理解错误导致问题一例

spring 中使用定时任务时一般是选择Quartz库的，quartz库较常用的一种配置是作用cron表达式，表达式的写法网上有很多文章，都写得很好，此处不在赘述。本篇仅描述一则表达式理解错误导致任务运行行为不符合预期的案例。出问题的表达式是这样的：

```java
//秒 分  时 日 月 
  * */10 * * * ? 
    
```

写这个表达式的同事的意图是想要某个任务**在任意时间，间隔10分钟就执行一次** ，但实际运行的结果却是**每隔10分钟会被连续执行很多次** ，这个问题出在  `*/10`  左侧的字段上 左侧 *秒* 字段的 值为`*`  ，这个值导致任务在10分钟被触发后，下一次执行时间为本次执行时间后1秒。（当然实际因为任务线程池可使用线程数量等限制因素，执行时间可能会推后）。所以如果是想要每隔10分钟执行一次任务，那么正确的表达式应该是这样的：

```java
//秒 分  时 日 月 
  0 */10 * * * ? 
```



### 其他

因为我们平时大多数定时任务都是在一定时间段执行一次的，所以一般不太会考虑到到某个时间段要执行很多次的情况，也就导致理解上认为左侧字段用 `*` 和用 `0` 没啥区别。但实际上Quartz做为任务框架，它应该是有这方面的任务需求需要满足的。因为本身对cron和quartz这两者不太熟悉，另外，当时同事的反馈是：时好时坏，所以查找原因时，还是走了一些歪路，后面一步步进入quartz源码调试，最终才发现问题所在。

另外，其实quartz的取下一次任务时间的代码应该是比较经典的写法，首先，他在创建任务时，会分析cron表达式，把每个字段符合的值都放到一个相对应的**TreeSet**类型字段里，秒是放在**seconds**集合变量中，分钟是放在**minutes**集合变量中，例如，当我在13:52:00 添加任务时，碰到上面原始的表达式时，会在 **seconds** 集合中添加 0-59总计60个int值，而 **minutes** 中，会添加2，12，22，32，42，52这几个int值。最终下一次执行时间通过从这些集合变量里取相应的值，拼接而成。规则细节可查看**org.quartz.CronExpression**实现。**CronExpression.getTimeAfter()**就是取下一次执行时间的方法。

